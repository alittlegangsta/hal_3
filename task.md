# 任务：

我现在要完成一个任务：

在测井中，利用已有的超声测井数据（即已知井的哪些部位发生窜槽），根据该数据来分析声波测井的测井声波的哪些成分或者是哪些时域或者频域的特征对流体成分敏感（即窜槽）。要求方法不需要太复杂，简单即可。并且要求提取特征的过程是可逆的，即当我最终识别到是什么特征对窜槽敏感后，当我有了新的声波信号数据，我可以通过该特征重新识别到是新的声波信号的哪些波对窜槽敏感。要求使用机器学习或者深度学习相关的ai方法。

已知在超声测井数据中，有深度点数据Depth，以及对应每一个深度点和方位角所接收到的值Zc，值的幅值越大代表胶结程度越好，幅值越小代表胶结程度越差，发生窜槽。

对于声波测井数据，有深度点数据Depth，以及对应每一个深度点、每一个时间点和每一个方位接收器的声波幅值。

---

# 需注意：

- 深度：在超声数据与声波数据深度对齐的情况下，对于声波数据，是以第7个阵列接收器所在的深度为深度基准点，并且阵列接收器是按编号由小到大按深度递减的方向排列。声源在第一个阵列接收器下方1feat处。根据基准接收器（第7个）的深度，计算每个接收器的实际深度。例如，接收器i的实际深度为基准深度 + (7 - i) × 0.5feat。

- 阵列接收器之间间距0.5feat

- 高通滤波：对于XSILMR声波数据，滤掉低于1000Hz的波，参考以下matlab代码：
  % High-pass filter
  
  dt=1e-5
  
  Fcut = 1000;
  
  Fs = 1/dt;
  
  [b,a] = butter(4,Fcut/(Fs/2),'high');

# 数据信息：

超声：具有很强的指向性，即是单发射源垂直于井筒，发射后再原路返回接收，每隔2度旋转发收一次，所以共180个方位角，总共360度。并且深度对应准确，深度分辨率高。

声波：就算每个阵列接收器都有8个方位接收器，但还是受所有方位的影响，由于是阵列接收器，且以第7个接收器为深度基准，每个接收器相隔0.5feat

1. ## XSILMR：

### 总体信息：

- data/raw/XSILMR文件夹下有13个.mat文件，为XSILMR01.mat-XSILMR13.mat，如“data/raw/XSILMR/XSILMR01.mat“

- 13个.mat文件分别一一对应13个阵列接收器。从1到13阵列接收器，沿轴向等间隔0.5feat排列，从1至13阵列接收器离单极子发射源越远，深度越浅。发射源在第一个阵列接收器下方1ft处

- 每一个阵列接收器都有8个方位接收器A-H，等深度点沿圆周方向360度等角度排列，每45度一个方位接收器。

- 因此共有13*8=104个接收器

- 阵列接收器以第7个阵列接收器所在深度为深度基准点。即例如在.mat文件中，第7个阵列接收器所在的深度为1000ft,则第6个阵列接收器所在深度为1000.5ft，而第8个阵列接收器所在深度为999.5ft。

- 数据结构是结构体

### 详细信息：

- 每一个.mat文件都是1*1大小，是struct类，以XSILRM04.mat举例，属性如下：
  
  | 参数名称           | 类型               | 值   |
  | -------------- | ---------------- | --- |
  | Depth          | 1×7108 double    | -   |
  | ACQ            | 1×7108 uint16    | -   |
  | Tad            | -                | 10  |
  | WaveRng04SideA | 1024×7108 double | -   |
  | WaveRng04SideB | 1024×7108 double | -   |
  | WaveRng04SideC | 1024×7108 double | -   |
  | WaveRng04SideD | 1024×7108 double | -   |
  | WaveRng04SideE | 1024×7108 double | -   |
  | WaveRng04SideF | 1024×7108 double | -   |
  | WaveRng04SideG | 1024×7108 double | -   |
  | WaveRng04SideH | 1024×7108 double | -   |
  
  - Depth:共7108个深度点，值范围：[2350.75678568363,5759.53416620890]，我需要对应深度值为2732-4132feat的对应的深度点范围，每个深度点之间相差0.49feat左右，深度在深度点的轴上由深至浅，数值由大变小。
  
  - WaveRng04SideA-WaveRngSideH，共8个方位接收器，每一个接收器所存储的值是1024*7108的double值，横轴1024是时间长度，时间间隔10us，纵轴7108是深度点，每一个double值是该时间点和深度点对应的声波振幅。

---

2. ## CAST:

### 总体信息：

- 路径为“data/raw/CAST.mat”
- 数据结构是结构体

### 详细信息：

- 该.mat文件为1*1大小，struct类，属性如下：
  
  | 参数名称  | 类型               | 值   |
  | ----- | ---------------- | --- |
  | Depth | 1×24750 double   | -   |
  | Zc    | 180×24750 single | -   |
  
  - Depth：共24750个深度点，值范围：[2395.44500001669,5804.33666668336]，我需要对应深度值为2732-4132feat的对应的深度点范围，每个深度点之间相差0.025feat左右，深度在深度点的轴上由深至浅，数值由大变小。
  
  - Zc：值是180×24750 为single类型。180对应角度点，共360度，即每个角度点相隔2度。24750是深度点，与Depth相对应。Zc每一个值对应该方位角和深度点的幅度值，幅度值越高代表胶结程度越好，没有窜槽发生，幅度值越低代表胶结程度越差，发生窜槽。从超声结果来看，可以视作以2.5为阈值，低于2.5的视为发生窜槽，高于2.5的则视为胶结良好

---

# **简化版解决方案：基于单个接收器（第3号）**

#### **I. 项目核心目标（已调整）**

利用已有的高分辨率超声测井数据（CAST）作为地面实况，通过AI模型分析**第3号阵列接收器**记录的声波波形，找出该特定接收器波形中，哪些时频特征对水泥胶结窜槽现象最敏感，并确保方法的可逆性。

#### **II. 核心方法论（已简化）**

1. **单接收器中心原则**：整个分析流程完全基于从`XSILMR03.mat`文件中获取的波形数据。所有其他接收器的数据将被忽略。

2. **精确局部化标签原则**：保持原方案中最强大的部分。为每一条来自第3号接收器的独立波形，根据其精确的物理位置（深度和方位），在CAST数据中生成一个高精度的、量化的回归标签。

3. **直接特征映射原则**：AI模型的核心任务是学习建立一个从“单个、原始（仅滤波）波形”的特征到其“局部胶结状况”的直接映射关系，不借助任何阵列处理带来的物理增强信息。

---

#### **III. 详细实施步骤与方法**

##### **阶段一：数据准备与物理对GINA（聚焦第3号接收器）**

- **功能**：加载必需的数据，并为`XSILMR03.mat`文件中的每一条波形计算出其精确的物理深度。

- **使用方法**：
  
  1. **数据加载**：
     
     - 加载 **`XSILMR03.mat`** 文件，获取第3号接收器的全套波形数据。
     
     - 加载 **`XSILMR07.mat`** 文件，**仅用于获取基准深度 `Depth` 数组**，因为它是深度基准点。
     
     - 加载 **`CAST.mat`** 文件，用于后续的标签生成。
  
  2. **第3号接收器深度计算**：
     
     - 遍历`XSILMR07.mat`中的`Depth`数组（我们称之为`D_base`数组）。
     
     - 对`D_base`数组中的每一个深度值，应用`i=3`的特定公式进行计算，得到一个**新的深度数组 `D_actual_R3`**，该数组的每一个元素都对应`XSILMR03.mat`中同一行的波形数据的真实物理深度。
     
     - **公式**：`D_actual_R3 = D_base + (7 - 3) * 0.5 ft = D_base + 2.0 ft`。
  
  3. **数据筛选**：
     
     - 使用新建的`D_actual_R3`深度数组，筛选`XSILMR03.mat`中的波形数据。
     
     - 同时，筛选`CAST.mat`中的数据，确保所有使用的数据都落在**2732英尺至4132英尺**的深度区间内。

##### **阶段二：单波形特征工程**

- **功能**：将来自第3号接收器的原始一维波形，转化为适合AI模型处理的特征。

- **使用方法**：
  
  1. **高通滤波**：对`XSILMR03`中筛选出的**每一条**独立波形，应用指定的**4阶巴特沃斯高通滤波器**，截止频率为1000Hz。**（注意：此步骤不包含任何阵列降噪功能，波形将保持其原有的噪声水平）**。
  
  2. **生成图像特征 `X_image`**：对滤波后的每一条波形，应用**连续小波变换（CWT）**，生成一张二维尺度图。这张图是模型学习的主要依据。
  
  3. **生成数值特征 `X_vector**：从同一条滤波后的波形中，计算一组一维数值特征，包括但不限于：最大绝对幅值、均方根幅值、峰值到达时间、信号偏度、峰度、主频（通过FFT计算）等。

##### **阶段三：为第3号接收器生成标签**

- **功能**：为第3号接收器的**每一条**波形，精确计算其对应的回归标签`Y`。

- **使用方法**：
  
  1. **确定目标方位**：`XSILMR03.mat`文件包含8个方位的波形数据（SideA至SideH）。您的处理需要按方位进行。例如，当您处理SideA的波形时，其对应的方位扇区为**[-22.5°, +22.5°]**。
  
  2. **计算“窜槽比例”标签**：遍历第3号接收器的每一条波形（例如，SideA在某个深度的波形），执行以下操作： a. 获取该波形精确的物理深度`D_actual_R3`（来自阶段一）。 b. 获取该波形的方位扇区（例如，`[-22.5°, +22.5°]`）。 c. 定义其**三维目标区域**： * **深度窗口**：**`[D_actual_R3 - 0.25 ft, D_actual_R3 + 0.25 ft]`**。这是一个以第3号接收器当前深度为中心，总宽度为0.5英尺的区间。 * **方位窗口**：即其所属的45度扇区。 d. 在此三维区域内，查询`CAST`数据，统计出所有数据点的总数`N_total`。 e. 在这些点中，统计出满足 `Zc < 2.5` 条件的点数 `N_channeling`。 f. 计算最终的回归标签 **`Y = N_channeling / N_total`**。

##### **阶段四：AI模型架构与训练**

- **功能**：构建并训练一个能够从第3号接收器的单波形特征预测其局部“窜槽比例”的AI模型。

- **使用方法**：
  
  1. **模型架构**：推荐使用**混合输入CNN模型**。一个分支处理尺度图（`X_image`），另一个分支处理数值特征向量（`X_vector`），然后将两者拼接后通过全连接层进行预测。
  
  2. **任务类型**：**回归（Regression）**。基于我们之前的分析，由于方位窗口内有足够的超声数据点，使得标签`Y`是统计稳定且准连续的。
  
  3. **损失函数**：使用**均方误差（Mean Squared Error, MSE）**。
  
  4. **训练流程**：将所有从第3号接收器生成的数据样本（特征X和标签Y）划分为训练集和验证集，然后进行模型训练。

##### **阶段五：模型解释与可逆应用**

- **功能**：分析已训练好的模型，找出第3号接收器波形中与窜槽相关的特征。

- **使用方法**：
  
  1. **敏感特征可视化**：在训练好的模型上，针对其CNN分支，应用**Grad-CAM**技术。
  
  2. **结果解释**：Grad-CAM生成的热力图会高亮显示在尺度图上。这些高亮区域，就代表了AI模型认为的、在**第3号接收器的单条波形中**，与窜槽现象最相关的时频特征。
  
  3. **应用流程**：当有一口新井的数据时，您同样只提取第3号接收器的波形，通过完全相同的流程进行处理和预测，并用Grad-CAM进行可视化解释。

---

# 要求：

1. 要求处理好的数据保存下来，以方便下次重新训练直接使用。并且要求能够检测到已有的处理好的数据文件直接加载使用。

2. 直接应用标签为高窜槽（尽可能高的窜槽比例）的第3号接收器的若干条波形作为阶段五的输入，然后生成热力图

3. 请先以小样本小epoch跑同一遍流程

4. 以几个样本生成声波信号的前后处理的对比图
